{% extends "engine/base.html" %}
{% load static %}
{% block title %}Generative Research Assistant â€” Sessions{% endblock %}

{% block extra_head %}
<script>
  // Set AI chat context when page loads
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof aiChatContext !== 'undefined') {
      aiChatContext = {
        module: document.getElementById('moduleSelect')?.value || '',
        dataset_name: document.querySelector('select[name="dataset_id"] option:checked')?.textContent || '',
        formula: document.getElementById('equationBox')?.value || ''
      };
      
      // Update context when form fields change
      const moduleSelect = document.getElementById('moduleSelect');
      const datasetSelect = document.querySelector('select[name="dataset_id"]');
      const formulaInput = document.getElementById('equationBox');
      
      if (moduleSelect) {
        moduleSelect.addEventListener('change', function() {
          aiChatContext.module = this.value;
        });
      }
      
      if (datasetSelect) {
        datasetSelect.addEventListener('change', function() {
          aiChatContext.dataset_name = this.options[this.selectedIndex]?.textContent || '';
        });
      }
      
      if (formulaInput) {
        formulaInput.addEventListener('input', function() {
          aiChatContext.formula = this.value;
        });
      }
    }
  });
</script>
<style>
  /* Loading spinner animation */
  .loading-spinner {
    animation: spin 2s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Modal animations */
  .modal {
    animation: fadeIn 0.3s ease-out;
  }
  
  .modal-content {
    animation: slideIn 0.3s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideIn {
    from { 
      opacity: 0;
      transform: translateY(-50px);
    }
    to { 
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Progress bar animation */
  #progressBar {
    transition: width 0.5s ease-in-out;
  }
  
  /* Loading status animation */
  #currentStep {
    transition: opacity 0.3s ease-in-out;
  }
  
  /* Artistic Visualize Button Animation */
  .visualize-btn-animated {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .visualize-btn-animated:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
  }
  
  .visualize-btn-animated:not(:disabled):active {
    transform: translateY(0);
  }
  
  .visualize-btn-text {
    position: relative;
    z-index: 2;
    display: inline-block;
    transition: transform 0.3s ease;
  }
  
  .visualize-btn-animated:not(:disabled):hover .visualize-btn-text {
    transform: scale(1.05);
  }
  
  .visualize-btn-shimmer {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    transition: left 0.5s ease;
    z-index: 1;
  }
  
  .visualize-btn-animated:not(:disabled):hover .visualize-btn-shimmer {
    left: 100%;
    animation: shimmer 1.5s infinite;
  }
  
  @keyframes shimmer {
    0% {
      left: -100%;
    }
    50% {
      left: 100%;
    }
    100% {
      left: 100%;
    }
  }
  
  /* Pulsing glow effect when enabled */
  .visualize-btn-animated:not(:disabled) {
    animation: pulseGlow 2s ease-in-out infinite;
  }
  
  @keyframes pulseGlow {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
    }
    50% {
      box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
    }
  }
  
  /* Floating particles effect */
  .visualize-btn-animated:not(:disabled)::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.6);
    transform: translate(-50%, -50%);
    animation: particleFloat 3s ease-in-out infinite;
    z-index: 0;
  }
  
  @keyframes particleFloat {
    0%, 100% {
      width: 0;
      height: 0;
      opacity: 0;
    }
    50% {
      width: 4px;
      height: 4px;
      opacity: 1;
      transform: translate(-50%, -50%) translateY(-20px);
    }
  }
  
  /* Drag and drop styles */
  .draggable-session {
    cursor: grab;
    user-select: none;
    transition: opacity 0.2s, transform 0.2s;
  }
  
  .draggable-session:active {
    cursor: grabbing;
  }
  
  .draggable-session:hover {
    transform: translateX(2px);
  }
  
  .paper-header {
    transition: background 0.2s, border 0.2s;
  }
  
  .paper-header.drag-over {
    background: #e0e7ff !important;
    border: 2px dashed #667eea !important;
  }
</style>
{% endblock %}
{# BEFORE (line ~6) #}
{# AFTER #}
{% if current and current.dataset %}
  <a class="btn secondary" href="{% url 'dataprep_open' current.dataset.id %}" onclick="event.preventDefault(); window.sbOpenModal(this.href);">
    Clean / Typesâ€¦
  </a>
{% endif %}

{% block sidebar %}

  <section class="card">
    <div class="card-header">
      <div class="card-actions">
        <button class="btn btn-sm btn-primary" onclick="showCreatePaperModal()" title="Create new paper">
          + New Paper
        </button>
        <button id="bulkDeleteBtn" class="btn btn-sm btn-danger" onclick="bulkDeleteSessions()" style="display: none;">
          Delete Selected
        </button>
        <button id="addToPaperBtn" class="btn btn-sm btn-primary" onclick="showAddToPaperModal()" style="display: none;">
          Add to Paper
        </button>
      </div>
    </div>
    <div class="modern-search">
      <div class="search-container">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input type="search" id="sessionFilter" placeholder="Search sessions..." oninput="filterSessions(this)" />
        <button class="search-clear" id="searchClear" onclick="clearSearch()" style="display: none;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="sessions-scroll-container">
      <ul id="sessionList" class="list">
        {% for item in papers_with_sessions %}
        <li class="paper-group-item" data-paper-id="{{item.paper.id}}">
          <div class="paper-header" data-paper-id="{{item.paper.id}}" data-paper-name="{{item.paper.name|escapejs}}" onclick="togglePaperCollapse({{item.paper.id}})" style="cursor: pointer; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
            <div class="row-left" style="display: flex; align-items: center; gap: 8px;">
              <svg class="paper-chevron" data-paper-id="{{item.paper.id}}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s; transform: rotate(0deg);">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
              <span class="paper-name" data-paper-id="{{item.paper.id}}" data-paper-name="{{item.paper.name|escapejs}}" ondblclick="event.stopPropagation(); renamePaper({{item.paper.id}}, '{{item.paper.name|escapejs}}', this)" style="font-weight: 600; color: #667eea; cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">{{item.paper.name}}</span>
              <span class="badge" style="background: #667eea; color: white;">{{item.sessions|length}}</span>
            </div>
            <div class="row-right" style="display: flex; align-items: center; gap: 4px;">
              <button class="icon-btn" title="Edit keywords and journals" aria-label="Edit keywords and journals" onclick="event.stopPropagation(); showKeywordsJournalsModal({{item.paper.id}}, '{{item.paper.name|escapejs}}')" style="padding: 4px 8px; color: #667eea;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="icon-btn danger" title="Delete paper" aria-label="Delete paper" onclick="event.stopPropagation(); deletePaper({{item.paper.id}}, '{{item.paper.name|escapejs}}')" style="padding: 4px 8px;">âœ•</button>
            </div>
          </div>
          <ul class="paper-sessions" id="paper-sessions-{{item.paper.id}}" style="display: none; margin-left: 24px; margin-bottom: 8px;">
            {% for s in item.sessions %}
            <li class="list-row session-item draggable-session" data-session-id="{{s.id}}" data-paper-id="{{s.paper_id|default:''}}" draggable="true" style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
              <div class="row-left" style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; overflow: hidden;">
                <input type="checkbox" class="session-checkbox" value="{{s.id}}" onchange="updateSelectionUI()" style="width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                <a class="link" href="/session/{{s.id}}/" style="flex-shrink: 0;">{{s.name}}</a>
                <span class="muted small" style="font-size: 0.75rem; color: #9ca3af; white-space: nowrap; flex-shrink: 0;">{{s.updated_at|date:"M d, H:i"}}</span>
                {% if not s.dataset_id %}<span class="badge warn" title="Dataset deleted" style="flex-shrink: 0;">no dataset</span>{% endif %}
              </div>
              <div class="row-right" style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                <button class="icon-btn" title="Remove from paper: {{s.paper.name}}" onclick="removeSessionFromPaper({{s.id}}, {{s.paper.id}})" style="color: #4CAF50; padding: 4px 8px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                  </svg>
                </button>
                <button class="icon-btn danger" title="Delete session" aria-label="Delete session" onclick="showSingleDeleteConfirmation({{s.id}}, '{{s.name|escapejs}}')">âœ•</button>
              </div>
            </li>
            {% empty %}
            <li class="muted" style="padding: 8px 12px; font-size: 0.875rem;">No sessions in this paper yet</li>
            {% endfor %}
          </ul>
        </li>
        {% endfor %}
        
        {% if ungrouped_sessions %}
        <li style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e5e7eb;">
          <div style="padding: 8px 12px; color: #6b7280; font-weight: 600; font-size: 0.875rem; margin-bottom: 8px;">Ungrouped Sessions</div>
          {% for s in ungrouped_sessions %}
          <li class="list-row session-item draggable-session" data-session-id="{{s.id}}" data-paper-id="" draggable="true" style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
            <div class="row-left" style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; overflow: hidden;">
              <input type="checkbox" class="session-checkbox" value="{{s.id}}" onchange="updateSelectionUI()" style="width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
              <a class="link" href="/session/{{s.id}}/" style="flex-shrink: 0;">{{s.name}}</a>
              <span class="muted small" style="font-size: 0.75rem; color: #9ca3af; white-space: nowrap; flex-shrink: 0;">{{s.updated_at|date:"M d, H:i"}}</span>
              {% if not s.dataset_id %}<span class="badge warn" title="Dataset deleted" style="flex-shrink: 0;">no dataset</span>{% endif %}
            </div>
            <div class="row-right" style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
              <button class="icon-btn danger" title="Delete session" aria-label="Delete session" onclick="showSingleDeleteConfirmation({{s.id}}, '{{s.name|escapejs}}')">âœ•</button>
            </div>
          </li>
          {% endfor %}
        </li>
        {% endif %}
        
        {% if not papers_with_sessions and not ungrouped_sessions %}
        <li class="muted">No sessions yet</li>
        {% endif %}
      </ul>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Datasets</h2>
      <div style="display:flex; align-items:center; gap:12px;">
        <span class="dataset-count">{{ datasets|length }} dataset{{ datasets|length|pluralize }}</span>
        <button id="mergeBtn" class="btn btn-sm" onclick="openMergeModal()" disabled style="background:linear-gradient(135deg, #f59e0b, #d97706); color:white; border:none; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:500; cursor:pointer; transition:all 0.2s;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px;">
            <path d="M17 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H7V5h10v14zM9 7h6v2H9V7zm0 4h6v2H9v-2zm0 4h6v2H9v-2z"/>
          </svg>
          Merge
        </button>
      </div>
    </div>
    
    {% if datasets %}
    <div class="dataset-list">
      {% for d in datasets %}
      <div class="dataset-item">
        <div style="margin-right:12px;">
          <input type="checkbox" class="dataset-checkbox" data-dataset-id="{{ d.id }}" data-dataset-name="{{ d.name }}" onchange="updateMergeButton()" style="width: 20px; height: 20px; cursor: pointer;">
        </div>
        <div class="dataset-info">
          <div class="dataset-name">
            <span class="file-icon">
              {% if d.name|slice:"-4:" == ".csv" %}
                ðŸ“Š
              {% elif d.name|slice:"-5:" == ".xlsx" or d.name|slice:"-4:" == ".xls" %}
                ðŸ“ˆ
              {% else %}
                ðŸ“„
              {% endif %}
            </span>
            <span class="name" title="{{ d.name }}">{{ d.name }}</span>
          </div>
          <div class="dataset-meta">
            <span class="upload-date">{{ d.uploaded_at|date:"M d, Y" }}</span>
            <span class="upload-time">{{ d.uploaded_at|date:"H:i" }}</span>
          </div>
        </div>
        <div class="dataset-actions">
          <a class="action-btn primary" href="{% url 'dataprep_open' d.id %}" onclick="event.preventDefault(); window.sbOpenModal(this.href);" title="Clean & Types">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
          </a>
          <button class="action-btn danger" type="button" title="Delete dataset" onclick="showDatasetDeleteConfirmation({{ d.id }}, '{{ d.name|escapejs }}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4zM8 9h8v10H8V9z"/>
            </svg>
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-icon">ðŸ“Š</div>
      <p class="empty-text">No datasets yet</p>
      <p class="empty-subtext">Upload your first dataset to get started</p>
    </div>
    {% endif %}

    <div class="upload-section">
      <h3 class="upload-title">Upload New Dataset</h3>
      <form action="/datasets/upload/" method="post" enctype="multipart/form-data" class="upload-form">
        {% csrf_token %}
        <div class="form-group">
          <label class="field-label">Display name (optional)</label>
          <input class="input" type="text" name="dataset_name" placeholder="Enter a custom name for your dataset">
        </div>
        <div class="form-group">
          <label class="dropzone" id="dropzone">
            <input type="file" name="dataset" required accept=".csv,.xlsx,.xls" id="fileInput" />
            <div class="dropzone-content">
              <div class="dropzone-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 15v4H5v-4H3v6h18v-6h-2zm-7-1l4-4h-3V4h-2v6H8l4 4z"/>
                </svg>
              </div>
              <div class="dropzone-text">
                <span class="dropzone-main">Drop files here or click to upload</span>
                <span class="dropzone-sub">Supports CSV, XLSX, and XLS files</span>
              </div>
            </div>
            <div class="upload-progress" id="uploadProgress" style="display: none;">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
              </div>
              <span class="progress-text" id="progressText">Uploading...</span>
            </div>
          </label>
        </div>
      </form>
    </div>
  </section>
{% endblock %}

{% block content %}
{% if error_message %}
<div class="card" style="background-color: #fef2f2; border-left: 4px solid #dc2626; margin-bottom: 20px; padding: 16px;">
  <div style="display: flex; align-items: center; gap: 12px;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="15" y1="9" x2="9" y2="15"></line>
      <line x1="9" y1="9" x2="15" y2="15"></line>
    </svg>
    <div>
      <h3 style="margin: 0 0 4px 0; color: #dc2626; font-size: 16px; font-weight: 600;">Model-Equation Mismatch</h3>
      <p style="margin: 0; color: #374151; line-height: 1.6;">{{ error_message }}</p>
    </div>
  </div>
</div>
{% endif %}

<form action="/run/" method="post" class="card form" id="analysisForm" onsubmit="event.preventDefault(); return handleFormSubmission(event);">
  {% csrf_token %}
  <input type="hidden" name="action" value="{% if current %}update{% else %}new{% endif %}">
  {% if current %}<input type="hidden" name="session_id" value="{{current.id}}">{% endif %}

  <!-- Essentials -->
  <div class="grid-3">
    <div>
      <label class="field-label">Session name</label>
      <div class="modern-search">
        <div class="search-container">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input type="text" name="session_name" value="{{current.name}}" placeholder="e.g., Pilot model on v1 dataset">
        </div>
      </div>
    </div>

    <div>
      <label class="field-label">Model</label>
      <div class="modern-search">
        <div class="search-container">
          <svg class="search-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <select name="module" id="moduleSelect" required>
            <!-- Null placeholder (default) -->
            <option value="" {% if not current or not current.module %}selected{% endif %}>Choose a modelâ€¦</option>
            {% for k, v in modules.items %}
              {% if k != 'bayesian' %}
                <option value="{{k}}" {% if current and current.module == k %}selected{% endif %}>
                  {% if k == 'regression' %}Regression
                  {% elif k == 'anova' %}ANOVA
                  {% elif k == 'varx' %}VARX
                  {% elif k == 'structural' %}SUR/2SLS/3SLS
                  {% else %}{{k|upper}}{% endif %}
                </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div>
      <label class="field-label">Dataset</label>
      <div class="modern-search">
        <div class="search-container">
          <svg class="search-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 21v-4a2 2 0 012-2h4a2 2 0 012 2v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 3v6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 6h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <select name="dataset_id" id="datasetSelect" required>
            <option value="">Select a dataset</option>
            {% for d in datasets %}
              <option value="{{d.id}}" {% if current and current.dataset_id == d.id %}selected{% endif %}>{{d.name}}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Analysis Type Selection -->
  <div class="grid-1" id="analysisTypeContainer" style="margin-bottom: 20px;">
    <div>
      <label class="field-label">Analysis Type</label>
      <div class="segment">
        <label>
          <input type="radio" name="analysis_type" value="frequentist" {% if not current or current.analysis_type == 'frequentist' %}checked{% endif %}>
          <span>Frequentist</span>
        </label>
        <label>
          <input type="radio" name="analysis_type" value="bayesian" {% if current and current.analysis_type == 'bayesian' %}checked{% endif %}>
          <span>Bayesian</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Structural Method Selection (shown only for structural model) -->
  <div class="grid-1" id="structuralMethodContainer" style="margin-bottom: 20px; display: none;">
    <div>
      <label class="field-label">Method</label>
      <div class="segment">
        <label>
          <input type="radio" name="structural_method" value="SUR" {% if not current or not current.options.method or current.options.method == 'SUR' %}checked{% endif %}>
          <span>SUR</span>
        </label>
        <label>
          <input type="radio" name="structural_method" value="2SLS" {% if current and current.options.method == '2SLS' %}checked{% endif %}>
          <span>2SLS</span>
        </label>
        <label>
          <input type="radio" name="structural_method" value="3SLS" {% if current and current.options.method == '3SLS' %}checked{% endif %}>
          <span>3SLS</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Chat-like equation box -->
  <div class="equation-wrap">
    <label class="field-label">Equation(s)</label>
    <div class="modern-search">
      <div class="search-container equation-container" style="position: relative;">
        <textarea name="formula" id="equationBox" rows="4"
          placeholder="Select a dataset first, then type your equation(s)â€¦

Examples:
  Regression (with interaction): y ~ x1 + x2 + x1:x2
  VARX: y1 + y2 ~ x1 + x2" {% if not current %}disabled{% endif %}>{% if current %}{{current.formula}}{% endif %}</textarea>
        <div id="autocompleteDropdown" class="autocomplete-dropdown" style="display: none;"></div>
      </div>
    </div>
    <div id="equationStatus" class="equation-status" style="margin-top: 8px; font-size: 14px;"></div>
  </div>

  <!-- Action buttons moved to results page -->
  <div class="toolbar">
    <button id="visualizeBtn" class="btn btn-secondary visualize-btn-animated" type="button" onclick="goToVisualize()" disabled
            style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; position: relative; overflow: hidden;"
            title="Select model & dataset, then type an equation to visualize">
      <span class="visualize-btn-text">Visualize</span>
      <span class="visualize-btn-shimmer"></span>
    </button>
    <button id="runBtn" class="btn btn-neutral" type="submit" disabled
            title="Select model & dataset, then type an equation">
      {% if current %}Update{% else %}Run{% endif %}
    </button>
    <button id="askAiBtn" class="btn" type="button" onclick="showGRAComingSoonPopup()" 
            style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none;"
            title="Talk to your GRA">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      Talk to your GRA
    </button>
  </div>

</form>

<!-- Error Fix Popup Modal -->
<div id="errorFixModal" class="error-modal" style="display: none;">
  <div class="error-modal-backdrop" onclick="closeErrorModal()"></div>
  <div class="error-modal-content">
    <div class="error-modal-header">
      <h3 id="errorModalTitle">Fix Equation Issues</h3>
      <button class="error-modal-close" onclick="closeErrorModal()">Ã—</button>
    </div>
    <div class="error-modal-body">
      <div id="errorModalMessage" class="error-modal-message"></div>
      <div class="error-modal-equation" style="display: none;">
        <label>Original:</label>
        <div class="equation-display" id="originalEquation"></div>
      </div>
      <div class="error-modal-equation" id="fixedEquationSection" style="display: none;">
        <label>Fixed:</label>
        <div class="equation-display fixed" id="fixedEquation"></div>
      </div>
      <div class="error-modal-unknown-vars" id="unknownVarsSection" style="display: none;">
        <label>Unknown variables:</label>
        <div class="unknown-vars-list" id="unknownVarsList"></div>
      </div>
    </div>
    <div class="error-modal-footer">
      <button id="acceptFixBtn" class="btn btn-primary" onclick="acceptFix()" style="display: none;">
        Accept Fix
      </button>
      <button id="dropUnknownBtn" class="btn btn-warning" onclick="dropUnknownVars()" style="display: none;">
        Drop Unknown Variables
      </button>
      <button id="returnToEditBtn" class="btn btn-secondary" onclick="returnToEdit()">
        Return to Edit
      </button>
    </div>
  </div>
</div>

        <!-- Merge Datasets Modal -->
        <div id="mergeModal" class="modern-modal" style="display: none;">
          <div class="modern-modal-backdrop" onclick="closeMergeModal()"></div>
          <div class="modern-modal-content">
            <div class="modern-modal-header">
              <div class="modal-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 12px;">
                  <path d="M17 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H7V5h10v14zM9 7h6v2H9V7zm0 4h6v2H9v-2zm0 4h6v2H9v-2z"/>
                </svg>
                <h2>Merge Datasets</h2>
              </div>
              <button class="modern-modal-close" onclick="closeMergeModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
              </button>
            </div>
            
            <div class="modern-modal-body">
              <div class="merge-instructions">
                <div class="instruction-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                </div>
                <div class="instruction-text">
                  <h3>How to merge datasets</h3>
                  <p>Select a column from each dataset that contains common values (like IDs or keys). The merge will combine rows where these columns have matching values.</p>
                </div>
              </div>
              
              <div id="mergeDatasetsList" class="datasets-selection">
                <!-- Selected datasets will be populated here -->
              </div>
              
              <div id="mergePreview" class="merge-preview">
                <div class="preview-header">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                  </svg>
                  <h3>Merge Preview</h3>
                </div>
                <div id="mergePreviewContent" class="preview-content">
                  Select columns to see merge preview
                </div>
              </div>
            </div>
            
            <div class="modern-modal-footer">
              <button onclick="closeMergeModal()" class="btn-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
                Cancel
              </button>
              <button onclick="executeMerge()" id="executeMergeBtn" class="btn-primary" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                  <path d="M17 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H7V5h10v14zM9 7h6v2H9V7zm0 4h6v2H9v-2zm0 4h6v2H9v-2z"/>
                </svg>
                Merge Datasets
              </button>
            </div>
          </div>
        </div>

  <!-- Bayesian Loading Modal -->
  <div id="bayesianLoadingModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
    <div class="modal-content" style="background-color: white; margin: 10% auto; padding: 32px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
      <div class="modal-header" style="text-align: center; margin-bottom: 24px;">
        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="loading-spinner">
            <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416">
              <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
              <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
            </circle>
          </svg>
        </div>
        <h3 style="margin: 0 0 8px 0; color: #111827; font-size: 20px; font-weight: 600;">Running Bayesian Analysis</h3>
        <p style="margin: 0; color: #6b7280; font-size: 14px;">This may take a few minutes depending on your data size and MCMC settings</p>
      </div>
      
      <div class="modal-body" style="text-align: center;">
        <div id="loadingStatus" style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #10b981;">
          <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Current Step:</div>
          <div id="currentStep" style="color: #6b7280; font-size: 14px;">Initializing Bayesian regression analysis...</div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 12px; color: #6b7280;">Progress</span>
            <span id="progressPercent" style="font-size: 12px; color: #6b7280;">0%</span>
          </div>
          <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
            <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 4px; transition: width 0.3s ease;"></div>
          </div>
        </div>
        
        <div id="loadingDetails" style="font-size: 12px; color: #9ca3af; margin-top: 16px;">
          <div>â€¢ MCMC sampling can take 1-5 minutes</div>
          <div>â€¢ Larger datasets require more time</div>
          <div>â€¢ You can safely close this window and return later</div>
        </div>
        
        <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: center;">
          <button type="button" onclick="cancelBayesianAnalysis()" class="btn btn-secondary" style="
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 12px 20px; 
            font-size: 14px; 
            font-weight: 600; 
            border-radius: 8px; 
            border: 1px solid #e5e7eb; 
            background: linear-gradient(135deg, #f8fafc, #f1f5f9); 
            color: #374151; 
            cursor: pointer; 
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
          " onmouseover="this.style.background='linear-gradient(135deg, #f1f5f9, #e2e8f0)'; this.style.borderColor='#d1d5db'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'" onmouseout="this.style.background='linear-gradient(135deg, #f8fafc, #f1f5f9)'; this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0;">
              <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Cancel Analysis
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dataset Delete Confirmation Modal -->
  <div id="datasetDeleteModal" class="modern-modal" style="display: none;">
    <div class="modern-modal-backdrop" onclick="closeDatasetDeleteModal()"></div>
    <div class="modern-modal-content">
      <div class="modern-modal-header">
        <div class="modal-title">
          <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 16px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <polyline points="3,6 5,6 21,6"></polyline>
              <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
          </div>
          <div>
            <h2 style="margin: 0; color: #1f2937; font-size: 1.25rem; font-weight: 600;">Delete Dataset</h2>
            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 0.875rem;">This action cannot be undone</p>
          </div>
        </div>
        <button class="modern-modal-close" onclick="closeDatasetDeleteModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      
      <div class="modern-modal-body">
        <div style="padding: 20px; background: #fef2f2; border-radius: 12px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="margin-right: 8px;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <span style="font-weight: 600; color: #dc2626;">Warning: Permanent Deletion</span>
          </div>
          <p style="margin: 0; color: #7f1d1d; font-size: 0.875rem; line-height: 1.5;">
            You are about to permanently delete the dataset <strong id="datasetDeleteName"></strong>. 
            This will also disconnect it from any analysis sessions that use it.
          </p>
        </div>
        
        <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 8px 0; color: #374151; font-size: 0.875rem; font-weight: 600;">What will happen:</h4>
          <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 0.875rem; line-height: 1.6;">
            <li>The dataset file will be permanently removed from the server</li>
            <li>All analysis sessions using this dataset will be disconnected</li>
            <li>This action cannot be undone</li>
          </ul>
        </div>
      </div>
      
      <div class="modern-modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeDatasetDeleteModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Cancel
        </button>
        <button type="button" class="btn btn-danger" onclick="confirmDatasetDelete()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
            <polyline points="3,6 5,6 21,6"></polyline>
            <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          Delete Dataset
        </button>
      </div>
    </div>
  </div>

<script>
// Bayesian Loading Management
let loadingModal = null;
let progressInterval = null;
let currentProgress = 0;

// Define the expected steps and their progress percentages
const bayesianSteps = [
  { step: "Initializing Bayesian regression analysis...", progress: 5 },
  { step: "Validating outcome variable...", progress: 10 },
  { step: "Preparing data and cleaning missing values...", progress: 15 },
  { step: "Data preparation completed successfully", progress: 20 },
  { step: "Creating Bayesian model with Bambi...", progress: 25 },
  { step: "Model created successfully", progress: 30 },
  { step: "Starting MCMC sampling...", progress: 35 },
  { step: "Running MCMC chains (this may take several minutes)...", progress: 50 },
  { step: "MCMC sampling completed successfully", progress: 75 },
  { step: "Computing posterior summary statistics...", progress: 85 },
  { step: "Summary statistics computed successfully", progress: 90 },
  { step: "Formatting results table...", progress: 95 },
  { step: "Finalizing results and preparing output...", progress: 98 },
  { step: "Analysis completed successfully!", progress: 100 }
];

function showBayesianLoadingModal() {
  console.log('showBayesianLoadingModal called');
  loadingModal = document.getElementById('bayesianLoadingModal');
  console.log('Loading modal element:', loadingModal);
  
  if (loadingModal) {
    console.log('Showing loading modal');
    loadingModal.style.display = 'block';
    currentProgress = 0;
    updateProgress(0, "Initializing Bayesian regression analysis...");
    
    // Start progress simulation
    startProgressSimulation();
  } else {
    console.error('Loading modal element not found!');
  }
}

function hideBayesianLoadingModal() {
  if (loadingModal) {
    loadingModal.style.display = 'none';
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
  }
}

function updateProgress(progress, step) {
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  const currentStep = document.getElementById('currentStep');
  
  if (progressBar) {
    progressBar.style.width = progress + '%';
  }
  if (progressPercent) {
    progressPercent.textContent = progress + '%';
  }
  if (currentStep) {
    currentStep.textContent = step;
  }
  
  currentProgress = progress;
}

function startProgressSimulation() {
  let stepIndex = 0;
  
  progressInterval = setInterval(() => {
    if (stepIndex < bayesianSteps.length) {
      const currentStepData = bayesianSteps[stepIndex];
      updateProgress(currentStepData.progress, currentStepData.step);
      stepIndex++;
    } else {
      // Keep the last step visible
      clearInterval(progressInterval);
      progressInterval = null;
    }
  }, 2000); // Update every 2 seconds
}

// Function to count dependent variables in equation
function countDependentVariables(formula) {
  if (!formula || !formula.trim()) return 0;
  
  // Split by newlines to handle multi-line equations (VARX format)
  const lines = formula.split('\n').map(line => line.trim()).filter(line => line.length > 0);
  
  let totalDVs = 0;
  for (const line of lines) {
    if (line.includes('~')) {
      const lhs = line.split('~')[0].trim();
      // Count variables on LHS (dependent variables)
      // Split by + and count non-empty parts
      const vars = lhs.split('+').map(v => v.trim()).filter(v => v.length > 0);
      totalDVs += vars.length;
    }
  }
  
  return totalDVs;
}

// Function to count number of equations (lines with ~, ignoring ~ inside brackets)
function countEquations(formula) {
  if (!formula || !formula.trim()) return 0;
  const lines = formula.split('\n').map(line => line.trim()).filter(line => line.length > 0);
  
  // Count lines that have ~ outside of bracket notation
  let count = 0;
  for (const line of lines) {
    // Remove bracket notation blocks [x ~ z] before checking for ~
    const lineWithoutBrackets = line.replace(/\[[^\]]*\]/g, '');
    if (lineWithoutBrackets.includes('~')) {
      count++;
    }
  }
  return count;
}

// Function to validate equation format matches selected model
function validateEquationModelMatch(formula, moduleValue) {
  if (!formula || !formula.trim()) return { valid: true };
  
  const equationCount = countEquations(formula);
  const dvCount = countDependentVariables(formula);
  
  // DIAGNOSTICS: Log validation info
  console.log('=== VALIDATE EQUATION MODEL MATCH DIAGNOSTICS ===');
  console.log('Formula:', formula);
  console.log('Module:', moduleValue);
  console.log('Equation count:', equationCount);
  console.log('Total dependent variables:', dvCount);
  
  // Check for multi-equation format (multiple lines with ~)
  if (equationCount > 1) {
    console.log('âœ“ MULTI-EQUATION FORMAT DETECTED:', equationCount, 'equations');
    // Regression and structural models support multi-equation format
    if (moduleValue !== 'regression' && moduleValue !== 'structural') {
      return {
        valid: false,
        error: 'Multi-equation format not supported',
        message: `You have ${equationCount} equation(s) (one per line), but ${moduleValue.toUpperCase()} models only support a single equation.\n\nPlease use only one equation, or select Regression/Structural model for multiple equations.`
      };
    }
    
    // Parse lines once for all multi-equation validations
    const lines = formula.split('\n').map(line => line.trim()).filter(line => line.length > 0 && line.includes('~'));
    
    // For structural models with multiple equations, each equation should have exactly 1 DV
    if (moduleValue === 'structural') {
      // Check if 2SLS is selected with multiple equations
      const structuralMethod = document.querySelector('input[name="structural_method"]:checked')?.value;
      if (structuralMethod === '2SLS' && equationCount > 1) {
        console.log('âœ— VALIDATION FAILED: 2SLS with multiple equations');
        console.log('=== END VALIDATE EQUATION MODEL MATCH DIAGNOSTICS ===');
        return {
          valid: false,
          error: '2SLS supports only one equation',
          message: `You have ${equationCount} equation(s), but 2SLS only supports a single equation.\n\nPlease use only one equation for 2SLS, or select SUR/3SLS method for multiple equations.`
        };
      }
      
      console.log('Validating each structural equation has exactly 1 DV...');
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const lhs = line.split('~')[0].trim();
        const vars = lhs.split('+').map(v => v.trim()).filter(v => v.length > 0);
        console.log(`  Line ${i + 1}: "${line}" - DVs: ${vars.length} (${vars.join(', ')})`);
        if (vars.length > 1) {
          console.log('âœ— VALIDATION FAILED: Line', i + 1, 'has', vars.length, 'dependent variables');
          console.log('=== END VALIDATE EQUATION MODEL MATCH DIAGNOSTICS ===');
          return {
            valid: false,
            error: 'Multiple dependent variables in one equation',
            message: `Line ${i + 1} has ${vars.length} dependent variable(s). In structural models, each equation must have exactly one dependent variable.\n\nPlease use one dependent variable per line, for example:\ny1 ~ x1 + x2\ny2 ~ x1 + [x3 ~ z1 + z2]`
          };
        }
      }
      console.log('âœ“ All structural equations validated: each has exactly 1 DV');
      // Return early for structural models - validation passed
      console.log('âœ“ VALIDATION PASSED');
      console.log('=== END VALIDATE EQUATION MODEL MATCH DIAGNOSTICS ===');
      return { valid: true };
    }
    
        // For regression with multiple equations, each equation should have exactly 1 DV
        console.log('Validating each equation has exactly 1 DV...');
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          // Remove bracket notation before splitting by ~
          const lineWithoutBrackets = line.replace(/\[[^\]]*\]/g, '');
          if (!lineWithoutBrackets.includes('~')) {
            continue; // Skip lines without ~ (after removing brackets)
          }
          const lhs = lineWithoutBrackets.split('~')[0].trim();
          const vars = lhs.split('+').map(v => v.trim()).filter(v => v.length > 0);
          console.log(`  Line ${i + 1}: "${line}" - DVs: ${vars.length} (${vars.join(', ')})`);
          if (vars.length > 1) {
        console.log('âœ— VALIDATION FAILED: Line', i + 1, 'has', vars.length, 'dependent variables');
        console.log('=== END VALIDATE EQUATION MODEL MATCH DIAGNOSTICS ===');
        return {
          valid: false,
          error: 'Multiple dependent variables in one equation',
          message: `Line ${i + 1} has ${vars.length} dependent variable(s). In multi-equation regression, each equation must have exactly one dependent variable.\n\nPlease use one dependent variable per line, for example:\ny1 ~ x1 + x2\ny2 ~ x1 + x3`
        };
      }
    }
    console.log('âœ“ All equations validated: each has exactly 1 DV');
  }
  
  // VARX requires 2+ dependent variables (but only in single equation format)
  if (moduleValue === 'varx' || moduleValue === 'varmax') {
    if (equationCount > 1) {
      return {
        valid: false,
        error: 'Multi-equation format not supported for VARX',
        message: `VARX/VARMAX models require a single equation with 2+ dependent variables, not multiple equations.\n\nPlease combine into one equation, for example:\ny1 + y2 ~ x1 + x2`
      };
    }
    if (dvCount < 2) {
      return {
        valid: false,
        error: 'VARX/VARMAX models require at least 2 dependent variables',
        message: `Your equation has ${dvCount} dependent variable(s), but VARX/VARMAX requires at least 2 dependent variables.\n\nPlease add more dependent variables before the ~ symbol, for example:\ny1 + y2 ~ x1 + x2`
      };
    }
  } else if ((moduleValue !== 'regression' && moduleValue !== 'structural') || equationCount === 1) {
    // For non-regression/structural models, or single-equation regression/structural, require exactly 1 dependent variable
    if (dvCount > 1) {
      return {
        valid: false,
        error: 'Multiple dependent variables not supported',
        message: `Your equation has ${dvCount} dependent variable(s), but ${moduleValue.toUpperCase()} models only support a single dependent variable.\n\nPlease use only one dependent variable before the ~ symbol, or select VARX model for multiple dependent variables.`
      };
    } else if (dvCount === 0) {
      return {
        valid: false,
        error: 'No dependent variable found',
        message: 'Your equation must have at least one dependent variable before the ~ symbol.'
      };
    }
  }
  
  console.log('âœ“ VALIDATION PASSED');
  console.log('=== END VALIDATE EQUATION MODEL MATCH DIAGNOSTICS ===');
  return { valid: true };
}

function handleFormSubmission(event) {
  // Always prevent default form submission first
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  
  console.log('handleFormSubmission called, module:', document.getElementById('moduleSelect')?.value);
  
  // Get the selected analysis type and module BEFORE other validations
  const analysisType = document.querySelector('input[name="analysis_type"]:checked')?.value;
  const moduleValue = document.getElementById('moduleSelect')?.value;
  const formula = document.getElementById('equationBox')?.value;
  
  console.log('Form values:', { analysisType, moduleValue, formula });
  
  // Validate equation format matches selected model FIRST (before other validations)
  if (moduleValue && formula) {
    const equationValidation = validateEquationModelMatch(formula, moduleValue);
    console.log('Equation validation result:', equationValidation);
    if (!equationValidation.valid) {
      console.log('Equation-model mismatch detected:', equationValidation);
      // Show modal immediately
      showEquationModelErrorModal(equationValidation.error, equationValidation.message);
      // Ensure we prevent submission
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      return false; // Prevent form submission
    }
  }
  
  // Then validate the form (basic checks)
  if (!validateFormSubmission()) {
    return false;
  }
  
  // Check for Bayesian regression with non-numeric DV before starting progress
  if (moduleValue === 'regression' && analysisType === 'bayesian' && formula) {
    // Extract dependent variable from equation
    if (formula.includes('~')) {
      const lhs = formula.split('~')[0].trim();
      const dv = lhs.split('+')[0].trim(); // Get first dependent variable
      
      // Check if DV is numeric
      if (window.datasetColumnTypes && window.datasetColumnTypes[dv]) {
        const dvType = window.datasetColumnTypes[dv];
        if (dvType !== 'numeric') {
          // Show error modal instead of proceeding
          showBayesianDVErrorModal(dvType);
          return false; // Prevent form submission
        }
      }
    }
  }
  
  // If it's a Bayesian analysis, show loading modal
  if (analysisType === 'bayesian') {
    console.log('Bayesian analysis detected, showing loading modal');
    showBayesianLoadingModal();
    
    // Disable submit button
    const submitBtn = document.querySelector('#runBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Running Analysis...';
    }
  }
  
  // All validations passed - proceed with form submission
  // The form will submit normally, or if there's a handleFormSubmission in app.js for AJAX, it will handle it
  // But we've already prevented default, so we need to submit manually
  const form = document.getElementById('analysisForm');
  
  // Add a hidden input to indicate which template to use
  const templateInput = document.createElement('input');
  templateInput.type = 'hidden';
  templateInput.name = 'template_override';
  templateInput.value = analysisType === 'bayesian' ? 'bayesian_results' : 'results';
  
  // Add it to the form
  form.appendChild(templateInput);
  
  // Submit the form normally (not via AJAX for now, to avoid conflicts)
  // If you need AJAX submission, it should be handled separately
  form.submit();
  return false; // Already prevented default
}

// Function to cancel Bayesian analysis
function cancelBayesianAnalysis() {
  console.log('Cancelling Bayesian analysis...');
  
  // Show modern confirmation dialog
  showCancelConfirmationModal();
}

// Function to show modern confirmation modal
function showCancelConfirmationModal() {
  // Create modal if it doesn't exist
  let modal = document.getElementById('cancelConfirmationModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'cancelConfirmationModal';
    modal.className = 'modal';
    modal.style.cssText = 'display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);';
    document.body.appendChild(modal);
  }
  
  // Create modal content
  modal.innerHTML = `
    <div class="modal-content" style="background-color: white; margin: 20% auto; padding: 32px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideIn 0.3s ease-out;">
      <div class="modal-header" style="text-align: center; margin-bottom: 24px;">
        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h3 style="margin: 0 0 8px 0; color: #111827; font-size: 20px; font-weight: 600;">Cancel Analysis?</h3>
        <p style="margin: 0; color: #6b7280; font-size: 14px; line-height: 1.5;">
          Are you sure you want to cancel the Bayesian analysis? This will stop the current analysis and you will need to restart it.
        </p>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: center;">
        <button type="button" onclick="closeCancelConfirmationModal()" class="btn btn-ghost" style="
          padding: 10px 20px; 
          font-size: 14px; 
          font-weight: 500; 
          border-radius: 8px; 
          border: 1px solid #e5e7eb; 
          background-color: #f9fafb; 
          color: #374151; 
          cursor: pointer; 
          transition: all 0.2s ease;
        " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='#f9fafb'">
          Keep Running
        </button>
        <button type="button" onclick="confirmCancelAnalysis()" class="btn btn-primary" style="
          display: flex; 
          align-items: center; 
          gap: 8px; 
          padding: 10px 20px; 
          font-size: 14px; 
          font-weight: 600; 
          border-radius: 8px; 
          border: none; 
          background: linear-gradient(135deg, #ef4444, #dc2626); 
          color: white; 
          cursor: pointer; 
          transition: all 0.2s ease;
          box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        " onmouseover="this.style.background='linear-gradient(135deg, #dc2626, #b91c1c)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'" onmouseout="this.style.background='linear-gradient(135deg, #ef4444, #dc2626)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0;">
            <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Yes, Cancel
        </button>
      </div>
    </div>
  `;
  
  modal.style.display = 'block';
  
  // Add click-outside-to-close functionality
  modal.onclick = function(event) {
    if (event.target === modal) {
      closeCancelConfirmationModal();
    }
  };
}

// Function to close confirmation modal
function closeCancelConfirmationModal() {
  const modal = document.getElementById('cancelConfirmationModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Function to confirm cancellation
function confirmCancelAnalysis() {
  closeCancelConfirmationModal();
  
  // Hide the loading modal
  hideBayesianLoadingModal();
  
  // Make a request to cancel the analysis
  fetch('/cancel-bayesian-analysis/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken')
    },
    body: JSON.stringify({
      session_id: null // No session ID available on index page
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showUpdateMessage('Analysis cancelled successfully');
      
      // Reload the page to reset the form
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } else {
      showUpdateMessage('Error cancelling analysis: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error cancelling analysis:', error);
    showUpdateMessage('Error cancelling analysis. Please try again.');
  });
}

// Helper function to get CSRF token from cookie
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Function to show update message
function showUpdateMessage(message) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed; top: 20px; right: 20px; z-index: 10000;
    background: #10b981; color: white; padding: 12px 16px;
    border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px; font-weight: 500;
  `;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Remove notification after 2 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 2000);
}

// Function to show notification
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed; top: 20px; right: 20px; z-index: 10001;
    padding: 12px 16px; border-radius: 8px; color: white;
    font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transform: translateX(100%); transition: transform 0.3s ease-out;
  `;
  
  const colors = {
    info: '#3b82f6',
    success: '#10b981',
    warning: '#f59e0b',
    error: '#ef4444'
  };
  
  notification.style.background = colors[type] || colors.info;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 10);
  
  // Auto remove
  setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Show Bayesian DV error modal
function showBayesianDVErrorModal(dvType) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.cssText = 'display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);';
  
  modal.innerHTML = `
    <div class="modal-content" style="background-color: white; margin: 15% auto; padding: 24px; border-radius: 12px; width: 80%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #dc2626; font-size: 1.25rem;">Bayesian Regression Not Supported</h3>
        <button type="button" onclick="closeBayesianDVErrorModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; align-items: center; margin-bottom: 16px; padding: 12px; background-color: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626;">
          <div style="margin-right: 12px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
          </div>
          <div>
            <p style="margin: 0; font-weight: 600; color: #dc2626;">Analysis Type Not Available</p>
          </div>
        </div>
        <p style="margin-bottom: 16px; color: #374151; line-height: 1.6;">
          Bayesian regression with <strong>${dvType}</strong> dependent variables is not yet supported in this version of the application.
        </p>
        <p style="margin-bottom: 20px; color: #6b7280; line-height: 1.6;">
          For categorical outcomes (binary, ordinal, multinomial), please use <strong>Frequentist Regression</strong> instead, which provides excellent results for these analysis types.
        </p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" class="btn btn-ghost" onclick="closeBayesianDVErrorModal()">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="switchToFrequentist()">Switch to Frequentist</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  window.currentModal = modal;
}

// Close Bayesian DV error modal
function closeBayesianDVErrorModal() {
  if (window.currentModal) {
    window.currentModal.remove();
    window.currentModal = null;
  }
}

// Function to show equation-model mismatch error modal
function showEquationModelErrorModal(errorTitle, errorMessage) {
  console.log('showEquationModelErrorModal called with:', errorTitle, errorMessage);
  
  const modal = document.getElementById('errorFixModal');
  const messageDiv = document.getElementById('errorModalMessage');
  const titleDiv = document.getElementById('errorModalTitle');
  
  console.log('Modal elements:', { modal: !!modal, messageDiv: !!messageDiv, titleDiv: !!titleDiv });
  
  if (!modal || !messageDiv) {
    // Fallback to alert if modal not found
    console.warn('Error modal elements not found, using alert fallback');
    alert(errorTitle + '\n\n' + errorMessage);
    return;
  }
  
  // Set title and message
  if (titleDiv) {
    titleDiv.textContent = errorTitle;
  }
  
  messageDiv.innerHTML = `
    <div style="margin-bottom: 16px;">
      <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 12px; background-color: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626;">
        <div style="margin-right: 12px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>
        <div>
          <p style="margin: 0; font-weight: 600; color: #dc2626;">Model-Equation Mismatch</p>
        </div>
      </div>
      <p style="margin: 0; color: #374151; line-height: 1.6; white-space: pre-line;">${errorMessage}</p>
    </div>
  `;
  
  // Hide sections that aren't relevant for this error
  const originalEqDiv = document.getElementById('originalEquation');
  const fixedEqSection = document.getElementById('fixedEquationSection');
  const unknownVarsSection = document.getElementById('unknownVarsSection');
  
  if (originalEqDiv) originalEqDiv.style.display = 'none';
  if (fixedEqSection) fixedEqSection.style.display = 'none';
  if (unknownVarsSection) unknownVarsSection.style.display = 'none';
  
  // Show modal - check CSS to see if it uses flex or block
  console.log('Showing error modal');
  // Try flex first (common for modals)
  modal.style.display = 'flex';
  
  // Force visibility
  modal.style.visibility = 'visible';
  modal.style.opacity = '1';
  modal.style.zIndex = '10000';
  
  // Ensure modal stays visible and is on top
  setTimeout(() => {
    if (modal.style.display === 'none' || modal.style.display === '') {
      console.warn('Modal was hidden, forcing to flex');
      modal.style.display = 'flex';
    }
    // Bring to front
    modal.style.zIndex = '10000';
  }, 50);
  
  // Also check if backdrop exists and show it
  const backdrop = modal.querySelector('.error-modal-backdrop');
  if (backdrop) {
    backdrop.style.display = 'block';
  }
  
  console.log('Modal should now be visible. Display:', modal.style.display, 'Visibility:', modal.style.visibility);
}

// Switch to frequentist analysis
function switchToFrequentist() {
  const frequentistRadio = document.querySelector('input[name="analysis_type"][value="frequentist"]');
  if (frequentistRadio) {
    frequentistRadio.checked = true;
    // Trigger change event to update UI
    frequentistRadio.dispatchEvent(new Event('change'));
  }
  closeBayesianDVErrorModal();
}

// Dataset Delete Confirmation Functions
let currentDatasetId = null;

function showDatasetDeleteConfirmation(datasetId, datasetName) {
  currentDatasetId = datasetId;
  const modal = document.getElementById('datasetDeleteModal');
  const nameElement = document.getElementById('datasetDeleteName');
  
  if (modal && nameElement) {
    nameElement.textContent = `"${datasetName}"`;
    modal.style.display = 'block';
  }
}

function closeDatasetDeleteModal() {
  const modal = document.getElementById('datasetDeleteModal');
  if (modal) {
    modal.style.display = 'none';
    currentDatasetId = null;
  }
}

function confirmDatasetDelete() {
  if (currentDatasetId) {
    // Create a form and submit it
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/datasets/delete/${currentDatasetId}/`;
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = csrfToken.value;
      form.appendChild(csrfInput);
    }
    
    document.body.appendChild(form);
    form.submit();
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log('Index page loaded');
  console.log('Loading modal element:', document.getElementById('bayesianLoadingModal'));
  console.log('Test button element:', document.querySelector('button[onclick="showBayesianLoadingModal()"]'));
  
  // Initialize analysis type toggle state
  updateAnalysisTypeToggle();
  
  // Initialize equation example if structural model is already selected
  const moduleSelect = document.getElementById('moduleSelect');
  if (moduleSelect && moduleSelect.value === 'structural') {
    updateStructuralEquationExample();
  }
});

// Function to update analysis type toggle based on model selection
function updateAnalysisTypeToggle() {
  const moduleSelect = document.getElementById('moduleSelect');
  const analysisTypeRadios = document.querySelectorAll('input[name="analysis_type"]');
  const analysisTypeContainer = document.getElementById('analysisTypeContainer');
  const structuralMethodContainer = document.getElementById('structuralMethodContainer');
  
  if (!moduleSelect || !analysisTypeContainer) return;
  
  const selectedModule = moduleSelect.value;
  
  if (selectedModule === 'bma' || selectedModule === 'anova' || selectedModule === 'varx') {
    // Disable analysis type toggle for BMA, ANOVA, and VARX
    analysisTypeContainer.style.display = 'none';
    structuralMethodContainer.style.display = 'none';
    // Uncheck all radio buttons
    analysisTypeRadios.forEach(radio => {
      radio.checked = false;
      radio.disabled = true;
    });
  } else if (selectedModule === 'structural') {
    // Hide analysis type toggle, show structural method toggle
    analysisTypeContainer.style.display = 'none';
    structuralMethodContainer.style.display = 'block';
    // Uncheck all analysis type radio buttons
    analysisTypeRadios.forEach(radio => {
      radio.checked = false;
      radio.disabled = true;
    });
    // Update equation box example based on selected method
    updateStructuralEquationExample();
  } else {
    // Enable analysis type toggle for other models
    analysisTypeContainer.style.display = 'block';
    structuralMethodContainer.style.display = 'none';
    analysisTypeRadios.forEach(radio => {
      radio.disabled = false;
    });
    // Set default to frequentist if nothing is selected
    if (!document.querySelector('input[name="analysis_type"]:checked')) {
      document.querySelector('input[name="analysis_type"][value="frequentist"]').checked = true;
    }
  }
}

// Function to update equation box with example when 2SLS or 3SLS is selected
function updateStructuralEquationExample() {
  const equationBox = document.getElementById('equationBox');
  const structuralMethod = document.querySelector('input[name="structural_method"]:checked')?.value;
  
  if (!equationBox) return;
  
  // Only update if textarea is empty or contains example text
  const currentValue = equationBox.value.trim();
  const isEmpty = currentValue.length === 0;
  const isExampleText = currentValue === 'y1 ~ x1 + x2 + [x3 ~ z1 + z2 + z3]' || 
                        currentValue === 'y1 ~ x1 + [x2 ~ z1 + z2]\ny2 ~ x1 + x2 + [x3 ~ z3 + z4]' ||
                        currentValue.includes('y1 ~ x1 + [x2 ~ z1 + z2]');
  
  // Don't overwrite user's actual input
  if (!isEmpty && !isExampleText) {
    return;
  }
  
  if (structuralMethod === '2SLS') {
    // 2SLS example (single equation with instruments)
    equationBox.value = 'y1 ~ x1 + x2 + [x3 ~ z1 + z2 + z3]';
    equationBox.placeholder = 'Enter equation with instruments in brackets [endogenous ~ instrument1 + instrument2]\n\nExample:\ny1 ~ x1 + x2 + [x3 ~ z1 + z2 + z3]';
  } else if (structuralMethod === '3SLS') {
    // 3SLS example (multiple equations with instruments)
    equationBox.value = 'y1 ~ x1 + [x2 ~ z1 + z2]\ny2 ~ x1 + x2 + [x3 ~ z3 + z4]';
    equationBox.placeholder = 'Enter equations (one per line) with instruments in brackets [endogenous ~ instrument1 + instrument2]\n\nExample:\ny1 ~ x1 + [x2 ~ z1 + z2]\ny2 ~ x1 + x2 + [x3 ~ z3 + z4]';
  } else if (structuralMethod === 'SUR') {
    // SUR example (multiple equations, no instruments needed)
    if (isEmpty || isExampleText) {
      equationBox.value = '';
    }
    equationBox.placeholder = 'Enter equations separated by newlines (one per line)\n\nExample:\ny1 ~ x1 + x2\ny2 ~ x1 + x3';
  }
}

// Add event listener to module select
document.addEventListener('DOMContentLoaded', function() {
  const moduleSelect = document.getElementById('moduleSelect');
  if (moduleSelect) {
    moduleSelect.addEventListener('change', updateAnalysisTypeToggle);
  }
  
  // Add event listeners for structural method radio buttons
  const structuralMethodRadios = document.querySelectorAll('input[name="structural_method"]');
  structuralMethodRadios.forEach(radio => {
    radio.addEventListener('change', updateStructuralEquationExample);
  });
});

function clearSearch() {
  const searchInput = document.getElementById('sessionFilter');
  const clearBtn = document.getElementById('searchClear');
  
  searchInput.value = '';
  clearBtn.style.display = 'none';
  filterSessions(searchInput);
  searchInput.focus();
}

function goToVisualize() {
  // Get form data
  const form = document.getElementById('analysisForm');
  const formData = new FormData(form);
  
  // Check if required fields are filled
  const module = formData.get('module');
  const datasetId = formData.get('dataset_id');
  const formula = formData.get('formula');
  
  if (!module || !datasetId || !formula) {
    alert('Please select a model, dataset, and enter an equation before visualizing.');
    return;
  }
  
  // Create a new form for visualization
  const visualizeForm = document.createElement('form');
  visualizeForm.method = 'POST';
  visualizeForm.action = '/visualize/';
  
  // Add CSRF token
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = csrfToken;
  visualizeForm.appendChild(csrfInput);
  
  // Add form data
  for (const [key, value] of formData.entries()) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = value;
    visualizeForm.appendChild(input);
  }
  
  // Submit the form
  document.body.appendChild(visualizeForm);
  visualizeForm.submit();
}

// Paper Management Functions
function updateSelectionUI() {
  const checkboxes = document.querySelectorAll('.session-checkbox:checked');
  const selectAllBtn = document.getElementById('selectAllBtn');
  const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
  const addToPaperBtn = document.getElementById('addToPaperBtn');
  
  if (checkboxes.length > 0) {
    if (selectAllBtn) selectAllBtn.style.display = 'inline-block';
    if (bulkDeleteBtn) bulkDeleteBtn.style.display = 'inline-block';
    if (addToPaperBtn) addToPaperBtn.style.display = 'inline-block';
  } else {
    if (selectAllBtn) selectAllBtn.style.display = 'none';
    if (bulkDeleteBtn) bulkDeleteBtn.style.display = 'none';
    if (addToPaperBtn) addToPaperBtn.style.display = 'none';
  }
}

function toggleSelectAll() {
  const checkboxes = document.querySelectorAll('.session-checkbox');
  const selectAllBtn = document.getElementById('selectAllBtn');
  const allChecked = Array.from(checkboxes).every(cb => cb.checked);
  
  checkboxes.forEach(cb => {
    cb.checked = !allChecked;
  });
  
  updateSelectionUI();
  if (selectAllBtn) {
    selectAllBtn.textContent = allChecked ? 'Select All' : 'Deselect All';
  }
}

function showCreatePaperModal(sessionIds = null) {
  // Get selected sessions if not provided
  if (!sessionIds) {
    const checkboxes = document.querySelectorAll('.session-checkbox:checked');
    sessionIds = Array.from(checkboxes).map(cb => cb.value);
  }
  
  // Get session names for display
  const sessionNames = [];
  if (sessionIds && sessionIds.length > 0) {
    sessionIds.forEach(id => {
      const sessionItem = document.querySelector(`.session-item[data-session-id="${id}"]`);
      if (sessionItem) {
        const sessionLink = sessionItem.querySelector('a.link');
        if (sessionLink) {
          sessionNames.push(sessionLink.textContent.trim());
        }
      }
    });
  }
  
  // Fetch existing papers
  fetch('/api/papers/', {
    method: 'GET',
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    },
    credentials: 'same-origin'
  })
  .then(response => response.json())
  .then(papers => {
    showPaperModal(papers, sessionIds, sessionNames);
  })
  .catch(error => {
    console.error('Error fetching papers:', error);
    showPaperModal([], sessionIds, sessionNames);
  });
}

function showAddToPaperModal() {
  const checkboxes = document.querySelectorAll('.session-checkbox:checked');
  if (checkboxes.length === 0) {
    showNotification('Please select at least one session', 'error');
    return;
  }
  
  const sessionIds = Array.from(checkboxes).map(cb => cb.value);
  showCreatePaperModal(sessionIds);
}

function showPaperModal(papers, sessionIds, sessionNames) {
  // Remove existing modal if any
  const existingModal = document.getElementById('paperModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Create modal overlay
  const modal = document.createElement('div');
  modal.id = 'paperModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);';
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background: white; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); animation: modalSlideIn 0.3s ease-out;';
  
  // Add animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
  `;
  document.head.appendChild(style);
  
  // Header
  const header = document.createElement('div');
  header.style.cssText = 'padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;';
  header.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px;">
      <div style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
      </div>
      <div>
        <h2 style="margin: 0; color: white; font-size: 1.5rem; font-weight: 600;">${sessionIds && sessionIds.length > 0 ? 'Add Sessions to Paper' : 'Create New Paper'}</h2>
        <p style="margin: 4px 0 0 0; color: rgba(255, 255, 255, 0.9); font-size: 0.875rem;">${sessionIds && sessionIds.length > 0 ? `Adding ${sessionIds.length} session(s)` : 'Organize your analysis sessions'}</p>
      </div>
    </div>
    <button id="closePaperModal" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  `;
  
  // Body
  const body = document.createElement('div');
  body.style.cssText = 'padding: 24px;';
  
  // Sessions list (if adding sessions)
  let sessionsHtml = '';
  if (sessionIds && sessionIds.length > 0) {
    sessionsHtml = `
      <div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 12px; border-left: 4px solid #667eea;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
          </svg>
          <h3 style="margin: 0; color: #1f2937; font-size: 1rem; font-weight: 600;">Selected Sessions (${sessionIds.length})</h3>
        </div>
        <div style="max-height: 150px; overflow-y: auto;">
          ${sessionNames.map((name, idx) => `
            <div style="padding: 8px 12px; background: white; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; border: 1px solid #e5e7eb;">
              <div style="width: 8px; height: 8px; background: #667eea; border-radius: 50%;"></div>
              <span style="color: #374151; font-size: 0.875rem;">${name}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  body.innerHTML = sessionsHtml + `
    <div style="margin-bottom: 24px;">
      <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 0.875rem;">
        Paper Name <span style="color: #ef4444;">*</span>
      </label>
      <input type="text" id="paperNameInput" placeholder="e.g., Research Paper 2024" 
             style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; box-sizing: border-box;"
             onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
    </div>
    <div style="margin-bottom: 24px;">
      <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 0.875rem;">Description (Optional)</label>
      <textarea id="paperDescriptionInput" placeholder="Brief description of this paper or project..." rows="3"
                style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; font-family: inherit; resize: vertical; transition: border-color 0.2s; box-sizing: border-box;"
                onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
    </div>
  `;
  
  // Footer
  const footer = document.createElement('div');
  footer.style.cssText = 'padding: 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; background: #f9fafb; border-radius: 0 0 16px 16px;';
  footer.innerHTML = `
    <button id="cancelPaperBtn" style="padding: 10px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; color: #374151; font-weight: 600; cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
      Cancel
    </button>
    <button id="submitPaperBtn" style="padding: 10px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);"
            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 8px -1px rgba(102, 126, 234, 0.4)'" 
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(102, 126, 234, 0.3)'">
      ${sessionIds && sessionIds.length > 0 ? 'Add to Paper' : 'Create Paper'}
    </button>
  `;
  
  // Assemble modal
  modalContent.appendChild(header);
  modalContent.appendChild(body);
  modalContent.appendChild(footer);
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Store sessionIds in modal for later use
  modal.dataset.sessionIds = sessionIds ? JSON.stringify(sessionIds) : '[]';
  
  // Event handlers - use setTimeout to ensure elements exist
  setTimeout(() => {
    const closeBtn = document.getElementById('closePaperModal');
    const cancelBtn = document.getElementById('cancelPaperBtn');
    const submitBtn = document.getElementById('submitPaperBtn');
    const nameInput = document.getElementById('paperNameInput');
    
    if (closeBtn) closeBtn.onclick = () => modal.remove();
    if (cancelBtn) cancelBtn.onclick = () => modal.remove();
    if (submitBtn) submitBtn.onclick = () => submitPaperForm(modal, sessionIds);
    if (nameInput) nameInput.focus();
    
    // Close on overlay click
    modal.onclick = (e) => {
      if (e.target === modal) modal.remove();
    };
  }, 10);
}

function selectExistingPaper(paperId, paperName) {
  const modal = document.getElementById('paperModal');
  if (!modal) return;
  
  const sessionIds = JSON.parse(modal.dataset.sessionIds || '[]');
  
  if (sessionIds.length === 0) {
    showNotification('No sessions selected', 'error');
    return;
  }
  
  // Add sessions to existing paper
  addSessionsToPaper(paperId, paperName, sessionIds)
    .then(() => {
      modal.remove();
    });
}

function submitPaperForm(modal, sessionIds) {
  const nameInput = document.getElementById('paperNameInput');
  const descriptionInput = document.getElementById('paperDescriptionInput');
  
  const name = nameInput.value.trim();
  if (!name) {
    showNotification('Paper name is required', 'error');
    nameInput.focus();
    return;
  }
  
  const description = descriptionInput.value.trim();
  
  // Create paper
  fetch('/papers/create/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: new URLSearchParams({
      'name': name,
      'description': description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // If sessions were selected, add them to the paper
      if (sessionIds && sessionIds.length > 0) {
        return addSessionsToPaper(data.paper_id, data.paper_name, sessionIds)
          .then(() => {
            modal.remove();
          });
      } else {
        showNotification('Paper created successfully!', 'success');
        modal.remove();
        setTimeout(() => location.reload(), 1000);
      }
    } else {
      showNotification(data.error || 'Failed to create paper', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error creating paper', 'error');
  });
}

function addSessionsToPaper(paperId, paperName, sessionIds = null) {
  if (!sessionIds) {
    const checkboxes = document.querySelectorAll('.session-checkbox:checked');
    if (checkboxes.length === 0) {
      showNotification('Please select at least one session', 'error');
      return Promise.reject('No sessions selected');
    }
    sessionIds = Array.from(checkboxes).map(cb => cb.value);
  }
  
  return fetch(`/papers/${paperId}/add-sessions/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      'session_ids': sessionIds
    })
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(data => {
        throw new Error(data.error || `HTTP error! status: ${response.status}`);
      });
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      showNotification(data.message || `Added ${data.updated_count} session(s) to "${paperName}"`, 'success');
      // Uncheck all checkboxes
      document.querySelectorAll('.session-checkbox').forEach(cb => cb.checked = false);
      updateSelectionUI();
      setTimeout(() => location.reload(), 1000);
      return data;
    } else {
      throw new Error(data.error || 'Failed to add sessions to paper');
    }
  })
  .catch(error => {
    console.error('Error in addSessionsToPaper:', error);
    throw error;
  });
}

function showAddSessionToPaperModal(sessionId) {
  // Use the same modal but with single session
  showCreatePaperModal([sessionId]);
}

function removeSessionFromPaper(sessionId, paperId) {
  if (!confirm('Remove this session from the paper?')) {
    return;
  }
  
  fetch(`/papers/${paperId}/remove-session/${sessionId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification(data.message || 'Session removed from paper', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showNotification(data.error || 'Failed to remove session', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error removing session from paper', 'error');
  });
}

function showKeywordsJournalsModal(paperId, paperName) {
  // Fetch current keywords, journals, and documents
  Promise.all([
    fetch(`/papers/${paperId}/keywords-journals/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCookie('csrftoken') }
    }).then(r => r.json()),
    fetch(`/papers/${paperId}/documents/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': getCookie('csrftoken') }
    }).then(r => r.json())
  ])
  .then(([keywordsData, documentsData]) => {
    if (keywordsData.success && documentsData.success) {
      openKeywordsJournalsModal(paperId, paperName, keywordsData.keywords || [], keywordsData.target_journals || [], documentsData.documents || []);
    } else {
      showNotification('Error loading data', 'error');
      openKeywordsJournalsModal(paperId, paperName, [], [], []);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    openKeywordsJournalsModal(paperId, paperName, [], [], []);
  });
}

function openKeywordsJournalsModal(paperId, paperName, keywords, journals, documents = []) {
  // Remove existing modal if any
  const existingModal = document.getElementById('keywordsJournalsModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Create modal overlay
  const modal = document.createElement('div');
  modal.id = 'keywordsJournalsModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);';
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background: white; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);';
  
  // Header
  const header = document.createElement('div');
  header.style.cssText = 'padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;';
  header.innerHTML = `
    <div>
      <h2 style="margin: 0; color: white; font-size: 1.5rem; font-weight: 600;">Keywords & Journals</h2>
      <p style="margin: 4px 0 0 0; color: rgba(255, 255, 255, 0.9); font-size: 0.875rem;">${paperName}</p>
    </div>
    <button id="closeKeywordsJournalsModal" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  `;
  
  // Body
  const body = document.createElement('div');
  body.style.cssText = 'padding: 24px;';
  body.innerHTML = `
    <div style="margin-bottom: 24px;">
      <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 0.875rem;">
        Keywords <span style="color: #6b7280; font-weight: 400;">(one per line)</span>
      </label>
      <textarea id="keywordsInput" rows="6" placeholder="Enter keywords, one per line&#10;Example:&#10;machine learning&#10;regression&#10;statistical analysis" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; font-family: inherit; resize: vertical; transition: border-color 0.2s; box-sizing: border-box;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">${keywords.join('\\n')}</textarea>
    </div>
    <div style="margin-bottom: 24px;">
      <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 0.875rem;">
        Target Journals <span style="color: #6b7280; font-weight: 400;">(one per line)</span>
      </label>
      <textarea id="journalsInput" rows="6" placeholder="Enter journal names, one per line&#10;Example:&#10;Journal of Applied Statistics&#10;American Statistical Review&#10;Journal of Econometrics" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; font-family: inherit; resize: vertical; transition: border-color 0.2s; box-sizing: border-box;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">${journals.join('\\n')}</textarea>
    </div>
    <div style="margin-bottom: 24px; padding-top: 24px; border-top: 2px solid #e5e7eb;">
      <label style="display: block; margin-bottom: 12px; color: #374151; font-weight: 600; font-size: 0.875rem;">
        Upload Documents <span style="color: #6b7280; font-weight: 400;">(for AI knowledge base)</span>
      </label>
      <div style="margin-bottom: 16px;">
        <input type="file" id="documentUpload" multiple accept=".pdf,.doc,.docx,.txt,.md" style="display: none;" onchange="handleFileSelect(this, ${paperId})">
        <button type="button" onclick="document.getElementById('documentUpload').click()" style="padding: 12px 20px; background: #f3f4f6; border: 2px dashed #d1d5db; border-radius: 8px; color: #374151; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;"
                onmouseover="this.style.background='#e5e7eb'; this.style.borderColor='#9ca3af'" onmouseout="this.style.background='#f3f4f6'; this.style.borderColor='#d1d5db'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Upload Files (PDF, DOC, DOCX, TXT, MD)
        </button>
        <div id="uploadProgress" style="display: none; margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 0.875rem; color: #0369a1;"></div>
      </div>
      <div id="documentsList" style="max-height: 200px; overflow-y: auto;">
        ${documents.length > 0 ? documents.map(doc => `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb;">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${doc.original_filename}</div>
              <div style="font-size: 0.75rem; color: #6b7280;">${doc.file_size_mb} MB â€¢ ${new Date(doc.uploaded_at).toLocaleDateString()}</div>
            </div>
            <div style="display: flex; gap: 8px; flex-shrink: 0;">
              <a href="/papers/${paperId}/documents/${doc.id}/download/" target="_blank" style="padding: 6px 12px; background: #667eea; color: white; border-radius: 6px; text-decoration: none; font-size: 0.75rem; font-weight: 600; transition: background 0.2s;"
                 onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">Download</a>
              <button onclick="deleteDocument(${paperId}, ${doc.id}, '${doc.original_filename.replace(/'/g, "\\'")}')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: background 0.2s;"
                      onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">Delete</button>
            </div>
          </div>
        `).join('') : '<div style="padding: 12px; text-align: center; color: #6b7280; font-size: 0.875rem;">No documents uploaded yet</div>'}
      </div>
    </div>
  `;
  
  // Footer
  const footer = document.createElement('div');
  footer.style.cssText = 'padding: 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; background: #f9fafb; border-radius: 0 0 16px 16px;';
  footer.innerHTML = `
    <button id="cancelKeywordsJournalsBtn" style="padding: 10px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; color: #374151; font-weight: 600; cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
      Cancel
    </button>
    <button id="saveKeywordsJournalsBtn" style="padding: 10px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);"
            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 8px -1px rgba(102, 126, 234, 0.4)'" 
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(102, 126, 234, 0.3)'">
      Save
    </button>
  `;
  
  // Assemble modal
  modalContent.appendChild(header);
  modalContent.appendChild(body);
  modalContent.appendChild(footer);
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Event handlers
  setTimeout(() => {
    const closeBtn = document.getElementById('closeKeywordsJournalsModal');
    const cancelBtn = document.getElementById('cancelKeywordsJournalsBtn');
    const saveBtn = document.getElementById('saveKeywordsJournalsBtn');
    
    if (closeBtn) closeBtn.onclick = () => modal.remove();
    if (cancelBtn) cancelBtn.onclick = () => modal.remove();
    if (saveBtn) saveBtn.onclick = () => {
      const keywordsText = document.getElementById('keywordsInput').value.trim();
      const journalsText = document.getElementById('journalsInput').value.trim();
      
      // Parse keywords and journals from textarea (one per line)
      const keywordsList = keywordsText ? keywordsText.split('\\n').map(k => k.trim()).filter(k => k) : [];
      const journalsList = journalsText ? journalsText.split('\\n').map(j => j.trim()).filter(j => j) : [];
      
      // Save to server
      fetch(`/papers/${paperId}/keywords-journals/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          keywords: keywordsList,
          target_journals: journalsList
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('Keywords and journals saved successfully', 'success');
          modal.remove();
          setTimeout(() => location.reload(), 1000);
        } else {
          showNotification(data.error || 'Failed to save keywords and journals', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Error saving keywords and journals', 'error');
      });
    };
    
    // Close on overlay click
    modal.onclick = (e) => {
      if (e.target === modal) modal.remove();
    };
    
    // Close on Escape key
    const escapeHandler = (e) => {
      if (e.key === 'Escape') {
        modal.remove();
        document.removeEventListener('keydown', escapeHandler);
      }
    };
    document.addEventListener('keydown', escapeHandler);
  }, 10);
}

function handleFileSelect(input, paperId) {
  const files = Array.from(input.files);
  if (files.length === 0) return;
  
  const progressDiv = document.getElementById('uploadProgress');
  progressDiv.style.display = 'block';
  progressDiv.textContent = `Uploading ${files.length} file(s)...`;
  
  const formData = new FormData();
  files.forEach((file, index) => {
    formData.append('file', file);
  });
  
  fetch(`/papers/${paperId}/documents/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': getCookie('csrftoken') },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      progressDiv.style.background = '#d1fae5';
      progressDiv.style.color = '#065f46';
      progressDiv.textContent = `Successfully uploaded ${files.length} file(s)!`;
      setTimeout(() => {
        location.reload();
      }, 1000);
    } else {
      progressDiv.style.background = '#fee2e2';
      progressDiv.style.color = '#991b1b';
      progressDiv.textContent = data.error || 'Upload failed';
    }
  })
  .catch(error => {
    console.error('Upload error:', error);
    progressDiv.style.background = '#fee2e2';
    progressDiv.style.color = '#991b1b';
    progressDiv.textContent = 'Upload failed. Please try again.';
  });
  
  // Reset input
  input.value = '';
}

function deleteDocument(paperId, documentId, filename) {
  // Remove existing modal if any
  const existingModal = document.getElementById('deleteDocumentModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Create modal overlay
  const modal = document.createElement('div');
  modal.id = 'deleteDocumentModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);';
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background: white; border-radius: 16px; width: 90%; max-width: 480px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); animation: modalSlideIn 0.3s ease-out;';
  
  // Icon and content
  modalContent.innerHTML = `
    <div style="padding: 32px; text-align: center;">
      <div style="width: 64px; height: 64px; margin: 0 auto 24px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </div>
      <h2 style="margin: 0 0 12px 0; color: #1f2937; font-size: 1.5rem; font-weight: 600;">Delete Document</h2>
      <p style="margin: 0 0 24px 0; color: #6b7280; font-size: 1rem; line-height: 1.5;">
        Are you sure you want to delete <strong style="color: #1f2937;">"${filename}"</strong>?<br>
        <span style="color: #9ca3af; font-size: 0.875rem;">This action cannot be undone.</span>
      </p>
      <div style="display: flex; gap: 12px; justify-content: center;">
        <button id="cancelDeleteDocumentBtn" style="padding: 10px 24px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; color: #374151; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
          Cancel
        </button>
        <button id="confirmDeleteDocumentBtn" style="padding: 10px 24px; background: #ef4444; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);"
                onmouseover="this.style.background='#dc2626'; this.style.boxShadow='0 6px 8px -1px rgba(239, 68, 68, 0.4)'" 
                onmouseout="this.style.background='#ef4444'; this.style.boxShadow='0 4px 6px -1px rgba(239, 68, 68, 0.3)'">
          Delete Document
        </button>
      </div>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Event handlers
  document.getElementById('cancelDeleteDocumentBtn').onclick = () => modal.remove();
  document.getElementById('confirmDeleteDocumentBtn').onclick = () => {
    modal.remove();
    performDeleteDocument(paperId, documentId, filename);
  };
  
  // Close on overlay click
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  
  // Close on Escape key
  const escapeHandler = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escapeHandler);
    }
  };
  document.addEventListener('keydown', escapeHandler);
}

function performDeleteDocument(paperId, documentId, filename) {
  fetch(`/papers/${paperId}/documents/${documentId}/`, {
    method: 'DELETE',
    headers: { 'X-CSRFToken': getCookie('csrftoken') }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Document deleted successfully', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      showNotification(data.error || 'Failed to delete document', 'error');
    }
  })
  .catch(error => {
    console.error('Delete error:', error);
    showNotification('Error deleting document', 'error');
  });
}

function deletePaper(paperId, paperName) {
  // Remove existing modal if any
  const existingModal = document.getElementById('deletePaperModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Create modal overlay
  const modal = document.createElement('div');
  modal.id = 'deletePaperModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);';
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background: white; border-radius: 16px; width: 90%; max-width: 480px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); animation: modalSlideIn 0.3s ease-out;';
  
  // Icon and content
  modalContent.innerHTML = `
    <div style="padding: 32px; text-align: center;">
      <div style="width: 64px; height: 64px; margin: 0 auto 24px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </div>
      <h2 style="margin: 0 0 12px 0; color: #1f2937; font-size: 1.5rem; font-weight: 600;">Delete Paper</h2>
      <p style="margin: 0 0 24px 0; color: #6b7280; font-size: 1rem; line-height: 1.5;">
        Are you sure you want to delete the paper <strong style="color: #1f2937;">"${paperName}"</strong>?<br>
        <span style="color: #9ca3af; font-size: 0.875rem;">Sessions will be ungrouped but not deleted.</span>
      </p>
      <div style="display: flex; gap: 12px; justify-content: center;">
        <button id="cancelDeleteBtn" style="padding: 10px 24px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; color: #374151; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
          Cancel
        </button>
        <button id="confirmDeleteBtn" style="padding: 10px 24px; background: #ef4444; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);"
                onmouseover="this.style.background='#dc2626'; this.style.boxShadow='0 6px 8px -1px rgba(239, 68, 68, 0.4)'" 
                onmouseout="this.style.background='#ef4444'; this.style.boxShadow='0 4px 6px -1px rgba(239, 68, 68, 0.3)'">
          Delete Paper
        </button>
      </div>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Event handlers
  document.getElementById('cancelDeleteBtn').onclick = () => modal.remove();
  document.getElementById('confirmDeleteBtn').onclick = () => {
    modal.remove();
    performDeletePaper(paperId, paperName);
  };
  
  // Close on overlay click
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  
  // Close on Escape key
  const escapeHandler = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escapeHandler);
    }
  };
  document.addEventListener('keydown', escapeHandler);
}

function performDeletePaper(paperId, paperName) {
  fetch(`/papers/${paperId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification(data.message || 'Paper deleted successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showNotification(data.error || 'Failed to delete paper', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error deleting paper', 'error');
  });
}

function renamePaper(paperId, currentName, element) {
  // Create input field
  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentName;
  input.style.cssText = 'font-weight: 600; color: #667eea; background: white; border: 2px solid #667eea; border-radius: 4px; padding: 4px 8px; font-size: inherit; font-family: inherit; width: 200px; outline: none;';
  
  // Replace span with input
  const parent = element.parentNode;
  parent.replaceChild(input, element);
  input.focus();
  input.select();
  
  const saveRename = () => {
    const newName = input.value.trim();
    if (!newName) {
      showNotification('Paper name cannot be empty', 'error');
      restoreName(element, currentName, parent);
      return;
    }
    
    if (newName === currentName) {
      restoreName(element, currentName, parent);
      return;
    }
    
    // Update paper name
    const formData = new URLSearchParams();
    formData.append('name', newName);
    
    fetch(`/papers/${paperId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Paper renamed successfully', 'success');
        // Update the element with new name
        element.textContent = newName;
        element.setAttribute('data-paper-name', newName);
        parent.replaceChild(element, input);
        // Update paper header data attribute
        const paperHeader = document.querySelector(`.paper-header[data-paper-id="${paperId}"]`);
        if (paperHeader) {
          paperHeader.setAttribute('data-paper-name', newName);
        }
      } else {
        showNotification(data.error || 'Failed to rename paper', 'error');
        restoreName(element, currentName, parent);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Error renaming paper', 'error');
      restoreName(element, currentName, parent);
    });
  };
  
  const restoreName = (el, name, parentEl) => {
    el.textContent = name;
    parentEl.replaceChild(el, input);
  };
  
  input.addEventListener('blur', saveRename);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      input.blur();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      restoreName(element, currentName, parent);
    }
  });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Paper collapse/expand functionality
function togglePaperCollapse(paperId) {
  const sessionsList = document.getElementById(`paper-sessions-${paperId}`);
  const chevron = document.querySelector(`.paper-chevron[data-paper-id="${paperId}"]`);
  
  if (sessionsList && chevron) {
    const isExpanded = sessionsList.style.display !== 'none';
    
    if (isExpanded) {
      // Already expanded - navigate to first session if available
      const firstSessionLink = sessionsList.querySelector('.session-item a.link');
      if (firstSessionLink) {
        window.location.href = firstSessionLink.getAttribute('href');
        return;
      }
      // No sessions, just collapse
      sessionsList.style.display = 'none';
      chevron.style.transform = 'rotate(0deg)';
    } else {
      // Collapsed - expand it
      sessionsList.style.display = 'block';
      chevron.style.transform = 'rotate(90deg)';
    }
  }
}

// Drag and drop functionality for sessions to papers
let draggedSession = null;
let dragOverPaper = null;

// Initialize drag and drop when DOM is ready
function initializeDragAndDrop() {
  // Make sessions draggable - use event delegation for dynamically added elements
  document.addEventListener('dragstart', function(e) {
    if (e.target.closest('.draggable-session')) {
      const session = e.target.closest('.draggable-session');
      if (session) {
        draggedSession = session;
        if (session.style) {
          session.style.opacity = '0.5';
        }
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', session.dataset.sessionId || '');
      }
    }
  }, true);
  
  document.addEventListener('dragend', function(e) {
    if (e.target.closest('.draggable-session')) {
      const session = e.target.closest('.draggable-session');
      if (session && session.style) {
        session.style.opacity = '1';
      }
      // Remove drop zone highlighting
      document.querySelectorAll('.paper-header').forEach(header => {
        if (header && header.style) {
          header.style.background = '';
          header.style.border = '';
        }
      });
      draggedSession = null;
    }
  }, true);
  
  // Make paper headers drop zones
  document.addEventListener('dragover', function(e) {
    const header = e.target.closest('.paper-header');
    if (header && draggedSession) {
      e.preventDefault();
      e.stopPropagation();
      e.dataTransfer.dropEffect = 'move';
      
      // Highlight drop zone
      if (dragOverPaper !== header) {
        // Remove highlight from previous paper
        if (dragOverPaper && dragOverPaper.style) {
          dragOverPaper.style.background = '';
          dragOverPaper.style.border = '';
        }
        dragOverPaper = header;
        if (header && header.style) {
          header.style.background = '#e0e7ff';
          header.style.border = '2px dashed #667eea';
        }
      }
    }
  }, true);
  
  document.addEventListener('dragleave', function(e) {
    const header = e.target.closest('.paper-header');
    if (header && !header.contains(e.relatedTarget)) {
      if (header.style) {
        header.style.background = '';
        header.style.border = '';
      }
      if (dragOverPaper === header) {
        dragOverPaper = null;
      }
    }
  }, true);
  
  document.addEventListener('drop', function(e) {
    const header = e.target.closest('.paper-header');
    if (header && draggedSession) {
      e.preventDefault();
      e.stopPropagation();
      
      // Remove highlight
      if (header && header.style) {
        header.style.background = '';
        header.style.border = '';
      }
      const previousDragOver = dragOverPaper;
      dragOverPaper = null;
      
      const sessionId = draggedSession.dataset.sessionId;
      const paperId = header.dataset.paperId;
      const paperName = header.dataset.paperName;
      
      if (!sessionId || !paperId) {
        console.error('Missing sessionId or paperId', { sessionId, paperId });
        return;
      }
      
      // Check if session is already in this paper
      const currentPaperId = draggedSession.dataset.paperId || '';
      if (currentPaperId === paperId) {
        showNotification('Session is already in this paper', 'info');
        return;
      }
      
      // Add session to paper
      addSessionsToPaper(paperId, paperName, [sessionId])
        .catch(error => {
          console.error('Error adding session to paper:', error);
          showNotification(error.message || 'Error adding session to paper', 'error');
        });
    }
  }, true);
}

document.addEventListener('DOMContentLoaded', function() {
  initializeDragAndDrop();
  
  // Initialize selection UI on page load
  updateSelectionUI();
  
  // Expand papers with sessions by default
  document.querySelectorAll('.paper-sessions').forEach(sessionsList => {
    const paperId = sessionsList.id.replace('paper-sessions-', '');
    const sessions = sessionsList.querySelectorAll('.session-item');
    if (sessions.length > 0) {
      // Expand if it has sessions
      sessionsList.style.display = 'block';
      const chevron = document.querySelector(`.paper-chevron[data-paper-id="${paperId}"]`);
      if (chevron) {
        chevron.style.transform = 'rotate(90deg)';
      }
    }
  });
});
</script>

{% endblock %}
